计算机网络是一门以计算机之间通信为主要任务的学问，它从硬件开始到应用层结束，对各个功能各种设备做了不同程度的抽象与封装。所以，你会在网络中看到各个层的结构，虽然在学术圈对网络层数有各种各样的划分，但是在这里，我们统一标准为 (自下而上) : **物理层** → **数据链路层** → **网络层** → **运输层** → **应用层**
其中每一层都有每一层的任务和功能以及对应的封装与抽象。

给一个不是那么恰当的比喻则是，应用层相当于你用的某个网购APP；运输层则是这个APP能选择的快递公司；网络层则是具体的快递收发站；数据链路层相当于实际给你送货的司机师傅；而物理层就是师傅开的那辆车。

对于计算机网络的学习，有相当一部分人都在推崇一种"自顶向下"的学习方式，即先从应用层开始到物理层结束。这能是源于《计算机网络：自顶向下》这把教材的影响。虽然从应用层开始学习更加容易接受，但是由于很多应用层协议严重依赖运输层协议提供的接口和服务，所以会导致应用层很多的细节内容没法进一步理解。所以我更希望从物理层开始学习。而从物理层开始学习的的困难在于很容易迷失在茫茫算法和协议中，所以本文旨在在学习正式开始之间提供一个导航和脉络，对于协议的细节可以自行学习。只要思路和方向建立起来，计算机网络也就容易很多了。

首先，我们需要知道的是计算机网络不是高高在上的，而是切切实实写在操作系统内的服务。无论是Windows还是Linux都提供很多网络API以及在shell中有大量的网络命令。换句话说就是将所有的协议以代码的方式写入的操作系统中。具体来说，网络层，运输层，应用层的协议和算法都写入了操作系统，而数据链路层和物理层的机制都作为硬件封装进网卡中。而操作系统作为硬件和软件的桥梁会与网卡进行数据交互从而完成各种网络协议和API。在Linux的源码中，具体来说是 net 文件夹就写有关于网络这部分的代码。同时，世界上有很多网络设备，实际上这些层的代码并不是在每种设备上都有的。毕竟很多设备不需要那么多功能，例如路由器上就只有物理层，数据链路层和网络层的协议；交换机上只有物理层和数据链路层的协议。这一方面是一种节约，更重要的是一种封装与抽象思想的体现。

其次，我们需要所谓协议，其实就是一些通信规范而已。具体来说，计算机之间的通信主要是通过发送报文和接收报文完成的，换句话说，报文就是计算机之间沟通的语言。所以协议就是这个"语言"的语法。

最后，我们要说明的是关于层层抽象和封装的思想，这种思想在计算机网络非常重要，对该思想的理解会直接决定你的学习体验。简单来说，这种思想的核心就是黑箱，也就是给黑箱一个输入，黑箱还一个输出。关于黑箱的细节，外接调用者一概不知。在计算机网络中有的天然的条件，外部调用者也是分层的。例如运输层可以调用网络层的服务，但是不会调用数据链路层的服务，甚至运输层对数据链路层的存在都感知不到。之后的说明中，我们会越来越多的解释这些。

为了和时代接轨，我们会额外介绍一下[[无线网络]]，但实际上，无线通信虽然贯穿所有层级，但是因为无线通信是通信领域的专业内容，所以无法在每一层都介绍一点最后额外的专门说明，实在是光无线通信写一本大部头的书籍完全是没问题的，我们没必要在这个问题上纠结，主要是没这个能力。

# 物理层
物理层实际上是一个无情的机器。由于不论是什么报文最后都要变成二进制在网络中传输，所以物理层负责主要的任务便是[[编码和调制]]。同时由于物理层是一个一个复杂的电路, 所以所有的电气特性包括连接器的形状、电压级别、线路引脚的配置、电缆的规格等都要在这一层全部封装好，也就是不要让上层 (数据链路层) 洞察这里面的细节。最后物理层还需要保证这些bit流可以正常发出去，因为在现实中有很多种[[有线传输介质]]和 [[数据交换方式]]，而物理层也要统合它们。

同时由于这一层是和物理电路有关的部分，所以在这里我们还需要学习一些[[通信基础]]，所以如果你是计算机出身的学生可能有点困难，不过通信基础并不是网络学习的重点，也不用有太大压力。

# 数据链路层
这一层的内容实际上非常多，因为这一层是给上层擦屁股的一层。也就是上层提供的很多服务和协议，具体落实都要到这一层。或许这一层是最容易和打工人引起共鸣的一层，可怜的数据链路层。

首先，数据链路层的直接下级是一个无情的机器，也就是如果发送的bit流因为不可抗力的原因发生了错误物理层是完全不知道的，所谓阿巴阿巴阿巴的机器是这样的。所以数据链路层必须提供[[差错控制]]机制，要让这种错误被领导 (网络层)知道前处理掉不然只能重发。具体来说，差错控制有俩个方面：检查错误和纠正错误。这里会讲到两个基础校验码（<u>奇偶校验码和CRC循环冗余码校验</u>）和三种纠错码（<u>海明码，里德-所罗门码，卷积码</u>）

第二，我们已经知道计算机之间的通信实际上是所谓的报文，而报文是有网络层送下来的，数据链路层要把这些报文[[封装成帧]]。实际上你问报文和帧之间有什么区别，其实这两个东西是作用在不用层上的东西，报文是更加侧重于内容，是网络层及以上的产物；而所谓帧是一个更加低层的概念，更加倾向于发送，所以在数据链路层会在帧中加入一些有助于检验和纠错的额外bits, 具体见[[差错控制]]。不仅需要[[封装成帧]]，更重要是自己夹杂的私货 (有助于检验和纠错的额外bits) 不能让上层 (网络层) 知道。所以在数据链路层受到别的计算机发生的帧时，需要在他这一层把这些私货全都收拾完。

第三，你会发现很多时候各种交换设备是共用一条线路的，不可能说一个设备接十个设备就要单独拉十条线。也就是说真实情况是多个通信点共用一条线路。如何保证在这一条线路上不同的帧互不干扰，并有效的利用线路资源，也是数据链路层需要关注的问题：[[介质访问控制]]，(接下来就是一段属性的贯口) 所谓信道划分主要分为两个思路：静态信道划分和动态信道划分。其中静态信道划分包括多路复用FDM，时分多路复用TDM，波分多路复用WDM，码分多路复用CDM；动态信道划分中又有两种访问，轮训访问（令牌机制）和随机访问，而随机访问中又有ALOHA协议，CSMA协议，CSMA/CD协议，CSMA/CA协议这四个协议。具体见[[介质访问控制]]。

第四，我们知道，最终我们要组成一个网络，一个网络必然需要统一一个协议去统一帧的格式，传输速率，以及之前说到的各个协议。这也就是我们常说[[以太网]] (实际上网络种类非常多，令牌环网，异步传输网络，无线局域网等等)，在以太网中，我们将介绍一个重要的概念：MAC地址 (这是我们真正意义上的物理地址，独一无二的地址)以及IEEE802规范，你会知道逻辑链路控制LLC和介质访问控制MAC。同时我们为了保证网络的安全和隐私需要将全世界（除了某些国家和地区）这一个巨大的以太网划分成若干个子网。这些子网根据规模还能分层局域网和广域网 (实际上更好的一个分类是：局域网用广播技术，广域网用点对点技术)。对于广域网使用PPP协议 (点对点协议)毕竟实在是网络太大了没法广播。对于局域网使用广播技术，因为不是那么多，但是即便如此还是有一种隔绝广播域的机制，也就是VLAN技术。

最后，如果你有千里眼，你就会知道网络层使用的地址叫做IP地址，但是数据链路层使用的是MAC地址，所以这里需要一个算法可以转换IP地址和MAC地址，也就是[[地址解析协议ARP]] 同时反过来也一样，即逆地址解析协议RARP，但是在现代的互联网中RAP协议已经不在被使用了，已经被DHCP协议所取代。同时还需要了解一下，工作在[[数据链路层的设备]]：交换机和网桥，这样你就知道以太网在物理上是怎么实现的了。

# 网络层
从这一层开始，就进入了计算机网络最重要也算最复杂的一层-网络层。可以说整个计算机网络协议栈中IP层可谓是中流砥柱。对上有领导 (TCP)对下工人 (数据链路层)，同时由于数据链路层中对MAC地址的封装，所以在IP层要基于IP地址实现几乎所有的计算机网络中的核心算法，从而真正意义上构成一个可用的网络。没错即便是有一堆算法和机制数据链路层还是很呆，甚至有的网络结构分类中干脆就把数据链路和物理层视为一层。

在网络层首先要知道网络层的两个终端是路由器，也就是到路由器为止 (网卡实际上内含了路由器的功能), 在往上的功能便不是网络层的职责所及了。其中对于网络层有两个核心功能：**转发**和**路由选择**。

对于转发，最重要的就是[[网际协议IP]]，这个协议中你必须知道，IP地址和网络分组，IP报文的基本格式 (IPv4和IPv6)以及报文的分片; IP地址同时划分出ABCD类网络；网络编址，子网划分和子网掩码和无分类编址CIDR；网络扩展和分类，也就是单播地址，广播地址和多播地址，对于多播还会介绍进行 [[IP多播]]的 [[网络组管理协议IGMP]] 以及[[多播路由选择协议]]；还有所谓 [[VPN技术和网络地址转换NAT]] (IP地址之间的转换)以及移动IP，也就是说IP地址不是一成不变而是可以被分配的。

对于路由选择，你首先要知道，网络中可以有非常多的路由器，而报文在发送出去之后应该怎么选择才能保证路径的选择是最优的？这里涉及到第一核心问题：[[路由选择算法]]，而对于静态路由和动态路由都是有不同的算法来计算路径。其中对于一个自治系统（AS）内部使用内部网关协议中的[[路由信息协议RIP]] 和[[自治系统内部控制协议OSPF]]，而对于自治系统AS之间的路由选择使用外部网关协议中的 [[边界网关协议BGP]]

之前已经说过，对于网络拥塞问题网络层也有自己的应对方式：之前说过的可以通过流量控制选择合适的路径来避免网络拥塞或者使用[[随机早期检测算法RED]]。对于网络拥塞这种问题确实也不是网络层也能解决的，在运输层中TCP也有自己的解决方式。

最后，如果报文出现问题，我们的主机应该怎么知道和处理呢？这里有一个主机和路由器沟通的协议- [[控制报文协议ICMP]]，这个协议可以用来检测各种网络环境，并给出错误反馈。

其实还有一个额外的思路，因为我们刚刚说的路由算法都是由各种硬件和算法完成的，如果把这些协议看做控制端 (路由算法)和数据端 (路由表)他们实际上是耦合在一起的。所以一个新的思路是把所有的控制端 (路由算法)都集成在一个远端的控制器上，这样控制的效率可以更高。这种方法叫做[[软件定义网络SDN]].

# 运输层
运输层和其他层一样, 屏蔽了下面的网络核心细节, 使得当进程在通信时只能看到两个运输层实体之间有一条端到端的逻辑信道. 在运输层上两个核心的协议是[[控制传输协议TCP]] 和[[用户数据报协议UDP]], 其他的所有协议算法都是为这两个核心服务的 (主要是TCP)。在报文经过了网络层也就是路由器之后，终于报文进入我们的主机，也就是经历了无数的路由器达到了目的主机。当网络层把报文交付给运输层时，**通信的终端就从路由之间的通信变为了计算机端口之间的通信**，所谓端口就相当于计算机的门，只是计算机设置了很多个端口，比如说用于HTTP服务的80端口；用于HTTPS的443端口；用于DNS的53端口。这些HTTP服务，HTTPS服务，DNS服务等，虽然是应用层的协议，但是在计算机都相当于进程。也就是说进程间的通信是依靠计算机的各个端口来实现的，所以说运输层是端口间的通信。（说到这个分上你也就应该知道了，应用层就是进程间的通信）TCP/IP 的运输层使用一个16位的端口号, 也就是说一太TCP/IP主机有65535个端口
![[运输层进程间通信.png]]
具体来说, 端口号分成两种：服务器端口号 (0~49151), 客户端端口号 (49152~65535). 服务器端口号又分成系统端口号 (0~1023)和登记端口号 (1024~49151). 简单来说, 服务器端口号是静态写死的; 客户端端口号是动态分配的


在介绍 [[控制传输协议TCP]] 之前首先要知道什么是[[可靠传输原理]]这其中就包括一个是基础的[[停止-等待协议]]，另外两个是基于滑动窗口策略的 [[可靠传输原理#后退N帧协议(GBN)]] 和[[可靠传输原理#选择重传协议(SR)]]，对于TCP协议你需要只要TCP为了保证可靠传输使用的大量的机制和算法，具体而言，你需要知道TCP的报文格式，[[连接管理]]也就是传说中的握手协议；[[可靠传输]]也就是所谓校验，序号，确认，重传一条龙服务；[[流量控制]]，也就是滑动窗口的机制；[[拥塞控制]]，当网络拥塞之后TCP为了保证可靠传输提供了四种算法：慢开始，拥塞避免，快重传，快恢复。虽然TCP提供了可靠的传输服务，但是TCP是没有加密的，也就是说报文是在链路上裸奔的。基于这个问题，现在出现了一个TCP的加密版本- [[安全套接字SSL]] 协议.

对于 [[用户数据报协议UDP]] 协议，其不提供可靠传输，也就是只提供传输这种最基础的服务。所以对于 [[用户数据报协议UDP]] 协议而言没有那么多机制，有序，丢失，重传一概不管。

在运输层和应用层之间还提供一个编程接口- [[网络套接字socket]]，用于两个进程间通信, 实际上不仅是不同计算机上的不同进程，更骚的是，就是一个主机上的两个进程用这种方式通信，也就是通过网络层提供的回环地址127.0.0.1并使用运输层提供的套接字来通信。

# 应用层
正如之前所说，到了应用层便是进程之间的通信，一切也就熟悉起来了。在应用层中，进程想给另一个进程发送一个报文。首先需要写地址。这个地址可以由两部分组成：**用户提供的地址和端口号**；此时的地址不在是IP地址和MAC地址，而是人类熟悉的地址，例如你要发邮件就写对方的邮箱地址，你要访问网站就写网址；这些地址会通过[[域名查询协议DNS]] 解析成对应的IP地址传给运输层。

同时在应用层，更多的被使用的术语是成了-服务，因为是直接面向用户的，所以要考虑用户体验。这些存在于应用层的服务会分别根据其性质不同而使用TCP或者UDP或者同时使用，例如[[域名查询协议DNS]] 就是在53端口同时使用TCP和UDP；而[[超文本传输协议HTTP]]，[[文件传输协议FTP]]，[[简单邮件传输协议SMTP]] 都是使用的TCP；而视频流，视频电话，语言服务都是使用UDP协议。

而且应用层提供了更多面向用户的网络管理和网络工具。例如：[[远程终端访问协议Telnet]]，[[动态主机配置协议DHCP]] [[简单网络管理协议SNMP]] 等服务。

在实际的物理设备中，不同的物理设备负责不用层的协议，
- 物理层使用的设备为转发器 (repeater)
- 数据链路层使用的设备为网桥 (bridge)
- 网络层使用的设备为路由器(router), 路由器是区分网络的一个设备，即工作在网络层以下的设备仅仅是扩大了网络规模。在逻辑是还是一个网络。
- 网络层以上使用的设备是网关 (gateway)，由于网络层以上的通信双方是端口和进程, 所以网关作用便是兼容不同的系统。

同时在这里还会提出一个目前而言最常用的网络模式：客户端-服务器（**client-server**）模式。也就是有一个服务器，所有的用户主机先和服务器通信，然后服务器统一处理这些请求。想对的还有用户不用过服务器直接和彼此沟通的peer-to-peer模式，即P2P模式。相比于中心化的client-server，P2P的这种去中心化的模式也是现在很多人都在研究的问题，例如区块链等等。

至此，计算机网络的脉络就算大致梳理完了，在这真正的最后用一张图来收尾，其实你会发现计算机网络其实并没有多难，一切都是非常清晰。
![[计算机网络的报文.png]] 
