DNS本质上是一个分布式数据库，里面存的是网络域名和IP地址之间转换等内容的对应。而DNS的组织形式是一个树状结构，如下图。例如：sun.tuc.noao.edu 这个域名sun就是公司的名字tuc是sun的上一级域名，而最后一级的域名则是edu。每一个独立管理的DNS子树称为一个域(zone)，而上述的noao.edu就是一个二级域。
![[DNS域名结构.png]]
我们的浏览器在拿到一个域名之后首先去距离自己最近的DNS服务器上找，如果没找到，这个子DNS服务器会告诉我们应该去哪里找，也就是上一级DNS服务器。
# 域名解析过程[核心]
现在由于网络的普及，不可能所有人上网之前都要去查询DNS服务器, 所以操作系统会在本地存一个缓存在浏览器中进行访问的时候，会优先查询浏览器缓存，如果未命中则继续查询操作系统缓存，最后再查询本地域名服务器，然后本地域名服务器会递归的查找域名记录，最后返回结果。**主机和本地域名服务器之间的查询方式是递归查询**，也就是说主机请求本地域名服务器，那么本地域名服务器作为请求的接收者一定要给主机想要的答案。

>[! summary] 
>总的来说，首先搜索**浏览器的 DNS 缓存**，缓存中维护一张域名与 IP 地址的对应表；
>若没有命中，则继续搜索**操作系统的 DNS 缓存**；
>若仍然没有命中，则操作系统将域名发送至**本地域名服务器**，本地域名服务器查询自己的 DNS 缓存，查找成功则返回结果[注意]：主机和本地域名服务器之间的查询方式是**递归查询**
>若本地域名服务器的 DNS 缓存没有命中，则本地域名服务器向上级域名服务器进行查询，通过以下方式进行**迭代查询**[注意]：本地域名服务器和其他域名服务器之间的查询方式是迭代查询，防止根域名服务器压力过大：
> - 首先本地域名服务器向**根域名服务器**发起请求，根域名服务器是最高层次的，它并不会直接指明这个域名对应的 IP 地址，而是返回顶级域名服务器的地址，也就是说给本地域名服务器指明一条道路，让他去这里寻找答案
> - 本地域名服务器拿到这个**顶级域名服务器**的地址后，就向其发起请求，获取**权限域名服务器**的地址
> - 本地域名服务器根据权限域名服务器的地址向其发起请求，最终得到该域名对应的 IP 地址
>  
> 本地域名服务器将得到的 IP 地址返回给操作系统，同时自己将 IP 地址缓存起来
> 操作系统将 IP 地址返回给浏览器，同时自己也将 IP 地址缓存起来
> 至此，浏览器就得到了域名对应的 IP 地址，并将 IP 地址缓存起来


# DNS的报文格式[可选]
DNS的报文格式是一个查询和响应通用的报文格式
![[DNS查询和传输的统一报文格式.png]]
这个报文由12字节长的首部和4个长度可变的字段组成。

标识字段由客户程序设置并由服务器返回结果。客户程序通过它来确定响应与查询是否匹配。
![[DNS报文-16bits标志字段.png]]

1. QR 是1 bit字段：0表示查询报文，1表示响应报文。
2. opcode 是一个4 bit字段：通常值为0（标准查询），其他值为1（反向查询）和2（服务器状态请求）。
3. AA是1 bit标志，表示“授权回答 (authoritative answer)”。该名字服务器是授权于该域的。
4. TC是1 bit字段，表示“可截断的 (truncated)”。使用U D P时，它表示当应答的总长度超过512字节时，只返回前512个字节。
5. RD是1 bit字段表示“期望递归（ recursion desired）”。该比特能在一个查询中设置，并在响应中返回。这个标志告诉名字服务器必须处理这个查询，也称为一个**递归查询**。如果该位为0，且被请求的名字服务器没有一个授权回答，它就返回一个能解答该查询的其他名字服务器列表，这称为**迭代查询**。所谓递归查询和迭代查询的区别非常简单：递归查询是我问你有没有，你去给我找，我在这里等你的结果；迭代查询是我问你有没有，你告诉我这里没有，你应该去哪里找，是我自己找。
6. RA是1 bit字段，表示“可用递归”。如果名字服务器支持递归查询，则在响应中将该比特设置为1。可看到大多数名字服务器都提供递归查询，除了某些根服务器。
7. 随后的3 bit字段必须为0。
8. rcode是一个4 bit的返回码字段。通常的值为 0（没有差错）和3（名字差错）。名字差错只有从一个授权名字服务器上返回，它表示在查询中制定的域名不存在。
9. 随后的 4个16 bit 字段说明最后 4个变长字段中包含的条目数。对于查询报文，问题(question)数通常是1，而其他3项则均为0。类似地，对于应答报文，回答数至少是 1，剩下的两项可以是0或非0。


## DNS查询报文中的查询问题部分
对于查询报文的“查询问题”字段。
![[DNS报文查询字段.png]]
查询名是要查找的名字，它是一个或多个标识符的序列。每个标识符以首字节的计数值
来说明随后标识符的字节长度，每个名字以最后字节为 0结束，长度为0的标识符是根标识符。计数字节的值必须是 0 ~ 63的数，因为标识符的最大长度仅为 63（在本节的后面我们将看到计数字节的最高两比特为1，即值192 ~ 255，将用于压缩格式）。不像我们已经看到的许多其他报文格式，该字段无需以整32 bit边界结束，即无需填充字节。
![[DNS保存查询-地址保存.png]]
每个问题有一个查询类型，而每个响应（也称一个资源记录，我们下面将谈到）也有一个类型。大约有20个不同的类型值，其中的一些目前已经过时。（最常见的就是查IP地址）

## DNS响应报文中的资源记录部分
DNS报文中最后的三个字段，回答字段、授权字段和附加信息字段，均采用一种称为资源记录RR（Resource Record）的相同格式。
![[DNS响应报文资源记录字段.png]]
域名是记录中资源数据对应的名字。它的格式和前面介绍的查询名字段格式相同
- 类型说明 R R的类型码。它的值和前面介绍的查询类型值是一样的
- 生存时间字段是客户程序保留该资源记录的秒数。资源记录通常的生存时间值为 2天
- 资源数据长度说明资源数据的数量。该数据的格式依赖于类型字段的值。


# 指针查询[可选]
所谓指针查询：**即给定一个 IP地址，返回与该地址对应的域名**。
![[DNS域名结构.png]]
回到上图, 查看一下顶级域a r p a，及它下面的in-addr域。当一个组织加入Internet，并获得DNS域名空间的授权，如noao.edu，则它们也获得了对应IP地址的in-addr.arpa域名空间的授权。在noao.edu这个例子中，它是网络号为140.252的B类网络。在DNS树中结点in-addr.arpa的下一级必须是该I P地址的第一字节 (例中为140)，再下一级为该IP地址的下一个字(252)，依此类推。但应牢记的是D N S名字是由D N S树的底部逐步向上书写的。这意味着对于I P地址为140.252.13.33的sun主机，它的DNS名字为33.13.252.140.in-addr.arpa。
必须写出4字节的I P地址，因为授权的代表是基于网络号： A类地址是第一字节，B类地址
是第一、二字节，C类地址则是第一、二、三字节。 I P地址的第一字节一定位于in-addr的下
一级，但 FQDN 却是自树底往上书写的。如果FQDN由顶往下书写，则这个I P地址的DNS名字将是arpa.in-addr. 140.252.13.33，而它所对应的域名将是edu.noao.tuc.sun。如果DNS树中没有独立的分支来处理这种地址—名字的转换，将无法进行这种反向转换，除非从树根开始依次尝试每个顶级域。毫不夸张地说，这将需要数天或数周的时间。虽然反写IP地址和特殊的域名会造成某些混乱，但 in-addr解决方案仍是一种最有效的方式。只有在使用host程序或tcpdump程序直接同DNS打交道时，才会担心 in-addr域和反写IP 地址影响我们。从应用的角度上看，正常的名字解析器函数（gethostbyaddr）将接收一个IP 地址并返回对应主机的有关信息。反转这些字节和添加in-addr. arpa域均由该函数自动完成。

**主机名检查**
当一个IP数据报到达一个作为服务器的主机时，无论是 UDP数据报还是TCP连接请求，服务器进程所能获得的是客户的 IP地址和端口号（ UDP或TCP）。某些服务器需要客户的 IP地址来获得在DNS中的指针记录。
其他的一些服务器如Rlogin服务器,不但需要客户的I P地址来获得指针记录，还要向DNS询问该I P地址所对应的域名，并检查返回的地址中是否有地址与收到的数据报中的源I P地址匹配。该检查是因为 .rhosts文件中的条目仅包含主机名，而没有IP地址，因此主机需要证实该主机名是否对应源 IP地址。
某些厂商将该项检查自动并入其名字解析器的例程中，特别是函数 gethostbyaddr
这使得任何使用名字解析器的程序均可获得这种检查，而无需在应用中人为地进行这项检查。

# DNS 主要使用的传输服务
注意到DNS名字服务器使用的熟知端口号无论对 UDP还是TCP都是 53。这意味着DNS均
支持UDP和TCP访问，但我们使用 tcpdump观察的所有例子都是采用 UDP。DNS主要使用UDP服务
当名字解析器发出一个查询请求，并且返回响应中的 TC（删减标志）比特被设置为 1时，它就意味着响应的长度超过了512个字节，而仅返回前512个字节。在遇到这种情况时，名字解析器通常使用T C P重发原来的查询请求，它将允许返回的响应超过 512个字节。既然TCP能将用户的数据流分为一些报文段，它就能用多个报文段来传送任意长度的用户数据。
此外，当一个域的辅助名字服务器在启动时，将从该域的主名字服务器执行区域传送。我们也说过辅助服务器将定时（通常是 3小时）向主服务器进行查询以便了解主服务器数据是否发生变动。如果有变动，将执行一次区域传送。区域传送将使用  TCP，因为这里传送的数据远比一个查询或响应多得多。