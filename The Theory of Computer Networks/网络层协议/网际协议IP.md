在网络层，提供的服务是无连接的尽最大努力的数据报服务。之前提到过虚电路服务，但是实际上在目前的TPC/IP协议中并不提供虚电路服务，虽然OSI体系曾极力主张使用虚电路服务。

# IPv4数据报
IP地址是每一台主机 (或者路由器)的每一个接口分配的全世界唯一的32位标识符 (IPv4), 这个地址是由ICANN（internet Corpration for Assigned Names and Numbers）进行分配的。
IPv4地址的发展进过了三个历史阶段：
1. 分类的IP地址
2. 子网划分
3. 无分类编址 (CIDR)

虽然IP是也是唯一的，但是它仍是逻辑地址，因为是有软件实现的。具体在硬件上跑的是MAC地址，但是MAC网络层是看不到的，站在网络层的视角只能看到和对方的网络层进行的通信
![[IP地址的逻辑地址属性.png]]
在路由器中记录的路由表也只是记录IP地址, 即便MAC地址可能千差万别, 但是通过低层的封装它们统一变成了IP地址。
## IPv4的历史阶段
### 分类的IP地址
之前说过IPv4的地址是32位标识符，将其分成两部分
- **网络号**(net-id)：其标志主机(或者路由器)所连接到的网络，这个网络号整个互联网唯一
- **主机号**(host-id)：标志具体是网络内主机的唯一标号，也就是这个唯一只是在当前网络唯一

这样分类的好处是ICANN只用分配网络号, 主机号由申请到该网络号的单位分配; 路由转发的时候只存目的网络的网络号。(路由器的每一个接口一个IP地址, 因为路由器至少要连接两个网络, 但实际上路由器确实至少连接两个网络, 对于两个路由器之间只有线路而没有网络的情况 (也算一种特殊网络)就不会分配IP地址, 这种情况称之为无名网络 (anonymous network))
所以IPv4的地址记作 **IPv4地址:={<网络号>, <主机号>}**。具体的划分如下：
![[IPv4地址的分类.png]]
其中
A, B, C类网络都是单播使用的，也就是一对一通信。而其前面的0,10,110就是类别位, 这个类别位也是包括在网络号中的，A, B, C类网络的网络号分别是1,2,3字节
D类网络，其类型号是1110，用于多播 (或者叫做广播，也就是一对多通信)
E类网络，其类型号是1111，用于以后使用。
实际上现在的IPv4已经不够用了，所以才有的IPv6。主要是当时没想到后来的互联网发展势头这么狠，地址马上就不够用了。而且这样的分类也很鸡肋，现在基本都是使用无分类的IP地址

为了书写方便，将32位23进制变为**点分十进制 (dotted decimal notation)**，例如：11101010.00110101.00101111.00110011 ⇒ 234.53.47.51
需要注意的是由于A, B, C, D有类型号，所以前1,2,3,4位是已经被指定好的, 所以
- A类地址网络号：1~126
- B类地址网络号：128~191
- C类地址网络号：192~223
- D类地址网络号：224~255

对于网络号, 在这些网络有一些特殊指定的网络号用于特殊的用途：
- 网络号全为0 则是保留地址，意味着**本网络 (this)**，也就是说0, 127, 192,  是不能指定的
- 网络号为 127, 这个特殊的网络号 (01111111) 作为本地软件的**环回测试 (loopback test)** 也就是给本机进程之间通信使用。只要用了127这个网络号，其数据包永远不会进入网络中

对于主机号，
- 主机号全0，表示本主机；注意网络号全0表示本网络。
- 主机号全1，表示该网络上的所有主机。

![[特殊网络和指派数.png]]
总的来说 A类网络的 0, 127 是无法指定的；B类网络的 128.0 是不能指定的；C类网络的 192. 0. 0 是不能指定的; 全0代表 this，而全1代表 all

对于IP地址到MAC的转换，可以参考 [[地址解析协议ARP]].

### 子网划分
在对于分类的IP地址，其实对IP地址空间是一种浪费, 例如
1. B类网络的主机数超过6万但实际上可能申请到B类网络的组织并没有多少主机，但是又不愿意申请C类网络。
2. 路由表如果太大也会使得网络性能变差。
3. 两级网络分类不够灵活。

所以基于以上原因，将主机号进一步划分为子网号和主机号。所以IP地址变为：



**IPv4地址:={<网络号>, <子网号>, <主机号>}**。部是看不到子网的，也就说子网仅仅只是一种内部调整标准。所以正常情况的报文还是只会走到网络号对应的路由器, 如下图，就是只能走到R1路由器
![[子网划分png.png]]
同时由于是在一次内部调整，从IP数据报中也看不出来，所以引入了**子网掩码(subnet mask)** 的概念来区分子网号和主机号。子网掩码的核心思路是：
在位运算中任何数字和1取与运算都是原来的数字；而和0取与都是0。
![[子网掩码.png]]
按照这个思路就会发现：子网掩码可以不是连续的1. 但是标准也没明确规定，但是实际上子网掩码都是连续的1.这样将子网掩码一并写入路由表中即可。如果没有子网掩码就使用默认子网掩码，就是网络号全1，主机号全0和之前一样。
![[ABC的默认子网掩码.png]]
但是即便使用了子网划分，也要注意不能和特殊的网络冲突，也就是子网号不能全0,1。同时要注意子网号号不能是**0,1,15,16**。注意，对于子网号位数是1的情况，就违背了子网号不能全0和全1的规则，因为只有1为只能非0即1. 由于全0全1不能用，所有所有的子网掩码所划分的子网都有-2. 例如子网号位数是2，就只能划分出2个子网；网号位数是3，就只能划分出6个子网；网号位数是4，就只能划分出14个子网；

如果路由器收到了一个IP数据报，如下图, 当 $R_1$ 收到一个IP数据包, 先通过数据报拿到目的IP地址D，然后开始比对：
1. 先看是不是和自己($R_{1}$) 直连的主机 (用子网掩码去和D逐位取AND)，如果是就直接分发
2. 再看看是不是发给特定主机路由的，如果是就直接给特定路由器
3. 再看是不是和自己有连接的路由器($R_2$)，把路由表中每一行 (目的地址，子网掩码，下一跳) 和D逐位取AND结果是N，匹配N和目的网络地址，如果是就跳转
4. 最后看看是不是要发给默认路由
5. 如果以上都不是就报一个分组错误
![[子网划分下的路由分发.png]]
### 无分类编址 (CIDR)
最开始使用变长子网掩码 (Variable Length Subnet Msak，VLSM)，然后又在VLSM的基础上研究出无分类编址的方式 ⇒ 无分类路由间选择（Classless Inter-Domain Routing, CIDR, 读作 sider） 

所谓无分类编址, 就是干脆别分A, B, C类网络，直接使用网络前缀 (network-prefix)和主机号的组合。至于网络前缀有多少位，就用一个额外的数字来制定，这个叫做**斜线记法 (slash notation)**, 例如：128.14.35.7/20 = <u>10000000.00001110.0010</u>0011.00000111 地址掩码：11111111.11000000.00000000
同样特殊地址, 主机号全0全1一般不用。把网络前缀都相同的地址块叫做CIDR地址块，对于上述例子可以简称 /20 地址块。
对于CIDR的使用的是地址掩码 (address mask) 也是一串连续的1和连续的0构成，斜线记法斜线后面的数字就是连续1的个数。

之前也说过, 子网掩码是一种内部调整，也就是说即便使用CIDR, 如果有需要还是可以进一步把主机号进行划分.

如果在路由器中使用CIDR来查找目的网络, 这样一个CIDR地址块就有很多地址, 这种地址聚合称之为**路由聚合 (route aggregation)**, 这样一个路由表中的项目就可以表示成很多路由. 这种路由聚合也叫做**构成超网 (supernetting)** 这样就大大减少了路由表的存储和查找开销

![[CIDR的开销.png]]

在使用CIDR之后, 路由表发生了变化, 变成了由 <网络前缀> 和 <下一跳> 构成, 在路由器进行匹配的时候可能出现不止一个结果，此时选择**最长匹配**
为了提高路由匹配的速度, 我们使用二叉线索树来进行查找。如下图。
![[线索二叉树进行路由匹配.png]]


## IP数据报的格式

![[IP数据报.png]]
IP数据报有两个部分：
1. 版本：4bits，说明这个数据报是IPv4还是IPv6; 但实际上如果是IPv6标准其实已经是另一个报文格式了
2. 首部长度：4bits，表示IPv4报文首部一共多少4字节，最小是5，因为有20字节固定长度；最长是15，也就是60个字节. 如果首部长度不是4的倍数，就用填充字段填到4字节
3. 区分服务：基本没什么用，使用区分服务的时候这个字段才有作用
4. 总长度：首段+数据的长度，最长 $2^{16}-1$ 个字节，也就是65535。但实际上没法做到这么长，因为数据链路层的MTU只有1500字节，如果超过1500字节，数据链路层会拆分。而且IP协议规定路由器和主机必须能接受不超过20+512+4=576个字节的长度的报文, 所以如果超过576个字节不一定所有路由都能接收。
5. 标识 (identification)：16bits, 当数据报超过1500字节就要分片，这个标识字段就是用来帮助重组的字段
6. 标志 (flag): 3bits, 但是只有前两位有意义
	1. 最低位记作 MF (More Fragment). MF=1 表示后面还有分片
	2. 中间位记作 DF (Don’t Fragment). DF=1 表示不能分片，也就是DF=0 时才能分片
7. 片偏移：13bits. 在分片之后, 某片在原来分组中的相对位置。片偏移以8个字节位偏移单位
8. 生存时间 (TTL)：8bits. 一个报文最长能存活16跳
9. 协议：8bits. 指明数据报中携带的数据使用的是什么协议 ![[常用协议字段.png]]
10. 首部检验和：16bits. 只检验首部. 检验方法为: 
	1.  发送方：先把IP数据报首部划分若干个16字节的序列，并把检验和字段置为0. 用反码算术运算把所有16位字相加之后，将得到的和的反码写入检验和字段
	2. 接收方：将首部16位字再使用算数反码相加, 将得到的和取反码，即得出接收方检验和得计算结果. 若首部没有变化则一定为0，于是保留，否则报错丢弃（所谓尽最大努力交付就是这种程度）![[IP层的检验机制.png]]

> [! example]
> 假设一个数据报总长度为 3820字节, 其数据部分长3800字节 (使用固定首部)，需要分片长度不超过1420字节的数据报。由于首部长度为20字节，所以每个数据报的数据部分不能超过1400字节。于是分为3个数据报片，其数据部分的长度分别为1400，1400，1000字节。原始数据报首部复制为各个数据报片的首部，但需修改有关字段
> ![[例子1.png]]
> 下图中标识是任意给定的 (12345)
> ![[例子1.1.png]]
> 如果，最后一段报片在进过某个路由时还需要再分成600和400. 则两个数据报片的总长度，标识，MF，DF和片偏移数据报分别为：820，12345，1，0，175；620，12345，1，0，275.

对于数据报的可变部分实际上压根不怎么用，IPv6的数据报就改成固定长度了

# IPv6数据报
![[IPv6.png]]
IPv6 数据报由两大部分组合，即基本首部 (base header)和有效载荷 (payload). 有效载荷允许有零个或者多个扩展首部 (extension header). 有效载荷不属于首部。

对于IPv6就不存在IP地址不够用的情况, 128位地址可以甚至可以保证地球上的每一粒沙子都有一个IP地址。
## IPv6做出的变化
- 取消了首部长度字段，IPv6的首部长度是固定 (40字节)
- 取消了服务类型，用优先级和流标号字段代替了
- 取消了总长度，改为了有效载荷长度
- 取消了标识，标志和偏移字段，将其功能包含着扩展首部中
- 取消了TTL，改为跳数限制
- 取消了协议，改用下一个首部字段
- 取消检验和
- 取消选项，改用扩展首部

## IPv6字段
1. 版本：4bits,
2. 通信量类 (traffic class): 8bits. 这是为了区别不同的IPv6数据报类别或优先级
3. 流标号 (flow label): 20bits, IPv6的新机制是资源预分配, 并且允许路由器把每一个数据报与一个给定的资源分配相联系。说白了就是IPv6支持通过流来传输视频, 音频数据
4. 有效载荷长度 (payload length): 16bits, 指明IPv6数据报除了基本首部以外的字节数, 最大值是64KB (65535字节)
5. 下一个首部 (next header)：8bits. 相当于IPv4的协议字段和可选字段
	1. IPv6 数据报没有扩展首部时，下一个首部字段的作用IPv4的协议字段一样，即指出了基本首部后面的数据交付使用了IP层的哪一个协议
	2. 使用扩展首部时，下一个首部字段的值就标识后面第一个扩展首部的类型
		1. 逐跳选项
		2. 路由选择
		3. 分片
		4. 鉴别
		5. 封装安全有效载荷
		6. 目的站选项
6. 跳数限制 (hop limit) : 8bits, 最大255跳
7. 源地址：128bits
8. 目的地址：128bits

## IPv6 地址
IPv6的目的地址可以是以下三种：
- 单播 (unicast): 点对点通信
- 多播 (multcast): 一对多通信，IPv6中没有广播，广播是作为多播的特例而存在
- 任播 (anycast): 任播的终点是一组计算机, 但数据报只能交付其中一个往往是最近的一个.

IPv6会对每一个结点也就是主机或者路由器每一个接口都分配一个IP地址, 也就是一个结点可以有多个单播地址。

由于IPv6地址为128位，所以IPv4的记法就没有没有意义了, 从而是用冒号16进制记法(colon hexadecimal notation，简称 colon hex), 其把每个16位的值用十六进制表示, 用冒号分隔, 
例如 104.230.140.100.255.255.255.255.0.0.17.128.150.10.255.255 ⇒ 68E6:8C64:FFFF:FFFF:0:1180:960A: FFFF；
如果中间的0很多还可以使用零压缩记法：
FF05:0:0:0:0:0:0: B3 ⇒ FF05:: B3 为了不混淆任意地址只使用一次零压缩;0:0:0:0:0:0:0:128.10.2.1= :: 128.10.2.1

同样在IPv6也可以使用CIDR, 

特殊地址：
- 未指明地址：16字节的全零地址，简写为 :: 这个地址不能位目的地址，只能作为源地址
- 环回地址：0:0:0:0:0:0:0:1 简写为 :: 1
- 多播地址：FF00::
- 本地链路单播地址
- 全球单播地址：![[IPv6单播地址划分.png]]

![[IPv6的特殊地址.png]]

## IPv4 向IPv6 的过渡
一般来说，IPv4往IPv6的过渡有两个方式，
1. 双栈协议：即一台主机既有IPv4协议又有IPv6协议, 主机通过DNS服务发送回来的地址来确定。![[双栈协议.png]] 如图所示，如果B使用双栈协议，当IPv6主机A发给B时，B将其转换为IPv4协议发送给C，但是IPv4数据报中有些信息是无法恢复为IPv6的，也就数在E处会有信息丢失。
2. 隧道技术：简单来说就是将IPv6的数据报作为IPv4的报文到达双栈路由器时在IPv6的数据拿出来发送给IPv4主机 ![[隧道技术.png]]





# 获取IP地址
为了获取一块 IP 地址用于一个组织的子网，某网络管理员也许首先会与他的 ISP 联系，该 ISP 可能会从已分给它的更大地址块中提供一些地址。
因特网名字和编号分配机构 (ICANN) 具有管理 IP 地址空间并向各 ISP 和其他组织分配地址块的最终责任.

某组织获得了一块地址，它就可为本组织内的主机与路由器接口逐个分配 E 地址。系统管理员通常手工配置路由器中的 E 地址 (常常在远程通过网络管理工具进行配置) 。主机地址也能手动配置，但是这项任务目前通常更多的是使用[[动态主机配置协议DHCP]]。