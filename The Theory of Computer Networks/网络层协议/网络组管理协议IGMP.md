![[IGMP报文格式.png]]
# IGMP 报告和查询
多播路由器使用IGMP报文来记录与该路由器相连网络中组成员的变化情况。使用规则如下：
1) 当第一个进程加入一个组时，主机就发送一个IGMP报告。如果一个主机的多个进程加入同一组，只发送一个IGMP报告。这个报告被发送到进程加入组所在的同一接口上。
2) 进程离开一个组时，主机不发送IGMP报告，即便是组中的最后一个进程离开。主机知道在确定的组中已不再有组成员后，在随后收到的IGMP查询中就不再发送报告报文。
3) 多播路由器定时发送IGMP查询来了解是否还有任何主机包含有属于多播组的进程。多播路由器必须向每个接口发送一个IGMP查询。因为路由器希望主机对它加入的每个多播组均发回一个报告，因此IGMP查询报文中的组地址被设置为0。
4) 主机通过发送IGMP报告来响应一个IGMP查询，对每个至少还包含一个进程的组均要发回IGMP报告。

使用这些查询和报告报文，多播路由器对每个接口保持一个表，表中记录接口上至少还包含一个主机的多播组。当路由器收到要转发的多播数据报时，它只将该数据报转发到（使用相应的多播链路层地址）还拥有属于那个组主机的接口上。
![[IGMP报告和查询.png]]
首先，当一个主机首次发送IGMP报告（当第一个进程加入一个多播组）时，并不保证该报告被可靠接收（因为使用的是I P交付服务）。下一个报告将在间隔一段时间后发送。这个时间间隔由主机在 0 ~ 1 0秒的范围内随机选择。其次，当一个主机收到一个从路由器发出的查询后，并不立即响应，而是经过一定的时间间隔后才发出一些响应（采用“响应”的复数形式是因为该主机必须对它参加的每个组均发送一个响应）。
在IGMP协议中：<font color="#c00000">多播路由器并不关心有多少主机属于该组，而只关心该组是否还至少拥有一个主机</font>。

这里TTL的初始值为1，这意味着IGMP的报文只能在同一个子网中发送，对于IGMP报文即便TTL=0也不会产生ICMP差错。
但是, 通过增加T T L值的方法，一个应用程序可实现对一个特定服务器的扩展环搜索 (expanding ring search)。第一个多播数据报以TTL等于1发送。如果没有响应，就尝试将 TTL设置为2，然后3，等等。在这种方式下，该应用能找到以跳数来度量的最近的服务器。

# IGMP的工作阶段
1. 某主机要加入组播组时, 该主机向组播组的组播地址发送一个IGMP报文, 声称自己要加入该组
2. 本地组播组接收到IGMP报文之后, 要利用组播路由选择协议把这个组成员关系发送到因特网上的其他组播路由器
3. 本地组播路由器周期探寻本地局域网上的主机, 以便知道这些主机是否还是组播组的成员
4. 只要有一个主机对某个组响应, 那么组播路由器就认为这个组是活跃的; 如果经过几次探寻后没有主机响应,，组播路由器就认为本网络上的没有此组播组的主机, 因此就不再把这个组的成员关系发送给起的组播路由器
